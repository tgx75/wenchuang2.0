{% extends 'interviewer/base.html' %}

{% load widget_tweaks %}



{% block page_title %}申请详情{% endblock %}

{% block main_content %}
<div class="mb-6">
    <a href="{% url 'application_list' %}{% for key, value in request.GET.items %}?{{ key }}={{ value }}{% endfor %}" class="inline-flex items-center text-gray-600 hover:text-autumn-600 transition-colors">
        <i data-lucide="arrow-left" class="w-5 h-5 mr-1"></i> 返回列表
    </a>
</div>

<div class="mb-8">
    <h1 class="text-2xl font-bold text-gray-800">申请详情</h1>
    <p class="text-gray-600 mt-1">
        {{ applicant.name }} ({{ applicant.student_id }}) 的申请信息
    </p>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- 左侧：基本信息 -->
    <div class="lg:col-span-1">
        <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
            <h2 class="text-lg font-semibold text-gray-800 mb-4 pb-2 border-b border-gray-200">基本信息</h2>
            
            <div class="space-y-4">
                <div>
                    <p class="text-sm text-gray-500">姓名</p>
                    <p class="text-gray-800">{{ applicant.name }}</p>
                </div>
                
                <div>
                    <p class="text-sm text-gray-500">学号</p>
                    <p class="text-gray-800">{{ applicant.student_id }}</p>
                </div>
                
                <div>
                    <p class="text-sm text-gray-500">年级</p>
                    <p class="text-gray-800">{{ applicant.grade }}</p>
                </div>
                
                <div>
                    <p class="text-sm text-gray-500">专业</p>
                    <p class="text-gray-800">{{ applicant.major }}</p>
                </div>
                
                <div>
                    <p class="text-sm text-gray-500">邮箱</p>
                    <p class="text-gray-800">{{ applicant.email }}</p>
                </div>
                
                <div>
                    <p class="text-sm text-gray-500">联系方式</p>
                    <p class="text-gray-800">{{ applicant.phone }}</p>
                </div>
                
                <div>
                    <p class="text-sm text-gray-500">第一志愿部门</p>
                    <p class="text-gray-800">{{ applicant.first_choice }}</p>
                </div>
                
                <div>
                    <p class="text-sm text-gray-500">第二志愿部门</p>
                    <p class="text-gray-800">{{ applicant.second_choice }}</p>
                </div>
                
                <div>
                    <p class="text-sm text-gray-500">申请时间</p>
                    <p class="text-gray-800">{{ applicant.created_at|date:"Y-m-d H:i" }}</p>
                </div>
            </div>
        </div>
        
        <!-- 简历 -->
        {% if applicant.resume %}
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-4 pb-2 border-b border-gray-200">简历</h2>
            
            <div class="flex items-center justify-center p-4 border-2 border-dashed border-gray-300 rounded-lg">
                <a href="{{ applicant.resume.url }}" target="_blank" class="flex items-center text-autumn-600 hover:text-autumn-800 hover:underline">
                    <i data-lucide="file-text" class="w-6 h-6 mr-2"></i>
                    <span>查看简历 (PDF)</span>
                </a>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- 右侧：流程和结果 -->
    <div class="lg:col-span-2">
        <!-- 流程状态 -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
            <h2 class="text-lg font-semibold text-gray-800 mb-6">申请流程</h2>
            
            <div class="relative">
                <!-- 连接线 -->
                <div class="absolute left-4 top-0 bottom-0 w-0.5 bg-gray-200"></div>
                
                <!-- 步骤1：简历筛选 -->
                <div class="relative pl-12 pb-8">
                    <div class="absolute left-0 top-1 w-8 h-8 rounded-full flex items-center justify-center {% if applicant.resume_result == '通过' %}bg-green-100 text-green-600{% elif applicant.resume_result == '未通过' %}bg-red-100 text-red-600{% else %}bg-gray-100 text-gray-600{% endif %}">
                        <i data-lucide="file-text" class="w-4 h-4"></i>
                    </div>
                    
                    <h3 class="text-base font-medium text-gray-900">简历筛选</h3>
                    
                    <div class="mt-2">
                        {% if applicant.resume_result == '通过' %}
                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">已通过</span>
                        {% elif applicant.resume_result == '未通过' %}
                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">未通过</span>
                        {% else %}
                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">待处理</span>
                        {% endif %}
                        
                        {% if applicant.resume_result %}
                        <p class="text-sm text-gray-500 mt-1">
                            处理时间：{{ applicant.updated_at|date:"Y-m-d H:i" }}
                        </p>
                        {% endif %}
                    </div>
                    
                    {% if applicant.resume_feedback %}
                    <div class="mt-3 p-3 bg-gray-50 rounded-lg border border-gray-100">
                        <p class="text-sm text-gray-700"><strong>反馈：</strong>{{ applicant.resume_feedback }}</p>
                    </div>
                    {% endif %}
                </div>
                
                <!-- 步骤2：第一志愿面试 -->
                <div class="relative pl-12 pb-8 {% if not applicant.resume_result or applicant.resume_result == '未通过' %}opacity-50{% endif %}">
                    <div class="absolute left-0 top-1 w-8 h-8 rounded-full flex items-center justify-center {% if applicant.first_interview_result == '通过' %}bg-green-100 text-green-600{% elif applicant.first_interview_result == '未通过' %}bg-red-100 text-red-600{% elif applicant.first_interview_status == '已安排' %}bg-yellow-100 text-yellow-600{% else %}bg-gray-100 text-gray-600{% endif %}">
                        <i data-lucide="users" class="w-4 h-4"></i>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <h3 class="text-base font-medium text-gray-900">第一志愿面试 ({{ applicant.first_choice }})</h3>
                        
                        {% if applicant.first_interview_time %}
                        <span class="text-sm text-gray-500">
                            <i data-lucide="clock" class="w-4 h-4 inline mr-1"></i>
                            {{ applicant.first_interview_time|date:"Y-m-d H:i" }}
                        </span>
                        {% endif %}
                    </div>
                    
                    <div class="mt-2">
                        {% if applicant.first_interview_result == '通过' %}
                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">已通过</span>
                        {% elif applicant.first_interview_result == '未通过' %}
                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">未通过</span>
                        {% elif applicant.first_interview_status == '已安排' %}
                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">已安排</span>
                        {% else %}
                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">未安排</span>
                        {% endif %}
                        
                        {% if applicant.first_interviewer %}
                        <p class="text-sm text-gray-500 mt-1">
                            面试官：{{ applicant.first_interviewer.name }}
                        </p>
                        {% endif %}
                    </div>
                    
                    {% if applicant.first_interview_feedback %}
                    <div class="mt-3 p-3 bg-gray-50 rounded-lg border border-gray-100">
                        <p class="text-sm text-gray-700"><strong>反馈：</strong>{{ applicant.first_interview_feedback }}</p>
                    </div>
                    {% endif %}
                </div>
                
                <!-- 步骤3：第二志愿面试 -->
                <div class="relative pl-12 pb-8 {% if not applicant.first_interview_result or applicant.first_interview_result == '通过' %}opacity-50{% endif %}">
                    <div class="absolute left-0 top-1 w-8 h-8 rounded-full flex items-center justify-center {% if applicant.second_interview_result == '通过' %}bg-green-100 text-green-600{% elif applicant.second_interview_result == '未通过' %}bg-red-100 text-red-600{% elif applicant.second_interview_status == '已安排' %}bg-yellow-100 text-yellow-600{% else %}bg-gray-100 text-gray-600{% endif %}">
                        <i data-lucide="users" class="w-4 h-4"></i>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <h3 class="text-base font-medium text-gray-900">第二志愿面试 ({{ applicant.second_choice }})</h3>
                        
                        {% if applicant.second_interview_time %}
                        <span class="text-sm text-gray-500">
                            <i data-lucide="clock" class="w-4 h-4 inline mr-1"></i>
                            {{ applicant.second_interview_time|date:"Y-m-d H:i" }}
                        </span>
                        {% endif %}
                    </div>
                    
                    <div class="mt-2">
                        {% if applicant.second_interview_result == '通过' %}
                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">已通过</span>
                        {% elif applicant.second_interview_result == '未通过' %}
                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">未通过</span>
                        {% elif applicant.second_interview_status == '已安排' %}
                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">已安排</span>
                        {% else %}
                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">未安排</span>
                        {% endif %}
                        
                        {% if applicant.second_interviewer %}
                        <p class="text-sm text-gray-500 mt-1">
                            面试官：{{ applicant.second_interviewer.name }}
                        </p>
                        {% endif %}
                    </div>
                    
                    {% if applicant.second_interview_feedback %}
                    <div class="mt-3 p-3 bg-gray-50 rounded-lg border border-gray-100">
                        <p class="text-sm text-gray-700"><strong>反馈：</strong>{{ applicant.second_interview_feedback }}</p>
                    </div>
                    {% endif %}
                </div>
                
                <!-- 步骤4：最终结果 -->
                <div class="relative pl-12 {% if not applicant.first_interview_result and not applicant.second_interview_result %}opacity-50{% endif %}">
                    <div class="absolute left-0 top-1 w-8 h-8 rounded-full flex items-center justify-center {% if applicant.admission_result == '录取' %}bg-green-100 text-green-600{% elif applicant.admission_result == '未录取' %}bg-red-100 text-red-600{% else %}bg-gray-100 text-gray-600{% endif %}">
                        <i data-lucide="check-circle" class="w-4 h-4"></i>
                    </div>
                    
                    <h3 class="text-base font-medium text-gray-900">最终录取结果</h3>
                    
                    <div class="mt-2">
                        {% if applicant.admission_result == '录取' %}
                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">已录取</span>
                        {% if applicant.admission_department %}
                        <p class="text-sm text-gray-700 mt-1">
                            录取部门：{{ applicant.admission_department }}
                        </p>
                        {% endif %}
                        {% elif applicant.admission_result == '未录取' %}
                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">未录取</span>
                        {% else %}
                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">待确定</span>
                        {% endif %}
                    </div>
                    
                    {% if applicant.admission_feedback %}
                    <div class="mt-3 p-3 bg-gray-50 rounded-lg border border-gray-100">
                        <p class="text-sm text-gray-700"><strong>反馈：</strong>{{ applicant.admission_feedback }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- 更新结果表单 -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-4 pb-2 border-b border-gray-200">更新结果</h2>
            
            <form method="post">
                {% csrf_token %}
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">更新阶段</label>
                    <select name="stage" id="stage-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-autumn-500 focus:border-autumn-500">
                        {% if not applicant.resume_result %}
                        <option value="resume" selected>简历筛选结果</option>
                        {% endif %}
                        
                        {% if applicant.resume_result == '通过' and applicant.first_choice == user_department and not applicant.first_interview_result %}
                        <option value="first_interview">第一志愿面试结果</option>
                        {% endif %}
                        
                        {% if applicant.first_interview_result == '未通过' and applicant.second_choice == user_department and not applicant.second_interview_result %}
                        <option value="second_interview">第二志愿面试结果</option>
                        {% endif %}
                        
                        {% if (applicant.first_interview_result or applicant.second_interview_result) and not applicant.admission_result and user.is_manager %}
                        <option value="admission">最终录取结果</option>
                        {% endif %}
                    </select>
                </div>
                
                <!-- 简历筛选结果 -->
                <div id="resume-section" class="stage-section {% if applicant.resume_result %}hidden{% endif %}">
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-1">简历筛选结果</label>
                        <div class="flex items-center space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="resume_result" value="通过" class="text-autumn-600 focus:ring-autumn-500" checked>
                                <span class="ml-2 text-gray-700">通过</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="resume_result" value="未通过" class="text-autumn-600 focus:ring-autumn-500">
                                <span class="ml-2 text-gray-700">未通过</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <label for="resume_feedback" class="block text-sm font-medium text-gray-700 mb-1">筛选反馈（可选）</label>
                        <textarea name="resume_feedback" id="resume_feedback" rows="3"
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-autumn-500 focus:border-autumn-500"
                                  placeholder="请输入对该简历的反馈意见..."></textarea>
                    </div>
                </div>
                
                <!-- 第一志愿面试结果 -->
                <div id="first_interview-section" class="stage-section hidden">
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-1">第一志愿面试结果</label>
                        <div class="flex items-center space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="first_interview_result" value="通过" class="text-autumn-600 focus:ring-autumn-500" checked>
                                <span class="ml-2 text-gray-700">通过</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="first_interview_result" value="未通过" class="text-autumn-600 focus:ring-autumn-500">
                                <span class="ml-2 text-gray-700">未通过</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <label for="first_interview_feedback" class="block text-sm font-medium text-gray-700 mb-1">面试反馈（可选）</label>
                        <textarea name="first_interview_feedback" id="first_interview_feedback" rows="3"
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-autumn-500 focus:border-autumn-500"
                                  placeholder="请输入面试反馈意见..."></textarea>
                    </div>
                </div>
                
                <!-- 第二志愿面试结果 -->
                <div id="second_interview-section" class="stage-section hidden">
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-1">第二志愿面试结果</label>
                        <div class="flex items-center space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="second_interview_result" value="通过" class="text-autumn-600 focus:ring-autumn-500" checked>
                                <span class="ml-2 text-gray-700">通过</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="second_interview_result" value="未通过" class="text-autumn-600 focus:ring-autumn-500">
                                <span class="ml-2 text-gray-700">未通过</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <label for="second_interview_feedback" class="block text-sm font-medium text-gray-700 mb-1">面试反馈（可选）</label>
                        <textarea name="second_interview_feedback" id="second_interview_feedback" rows="3"
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-autumn-500 focus:border-autumn-500"
                                  placeholder="请输入面试反馈意见..."></textarea>
                    </div>
                </div>
                
                <!-- 录取结果 -->
                <div id="admission-section" class="stage-section hidden">
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-1">最终录取结果</label>
                        <div class="flex items-center space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="admission_result" value="录取" class="text-autumn-600 focus:ring-autumn-500" checked>
                                <span class="ml-2 text-gray-700">录取</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="admission_result" value="未录取" class="text-autumn-600 focus:ring-autumn-500">
                                <span class="ml-2 text-gray-700">未录取</span>
                            </label>
                        </div>
                    </div>
                    
                    {% if applicant.first_interview_result == '通过' %}
                    <div class="mb-6">
                        <label for="admission_department" class="block text-sm font-medium text-gray-700 mb-1">录取部门</label>
                        <select name="admission_department" id="admission_department" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-autumn-500 focus:border-autumn-500">
                            <option value="{{ applicant.first_choice }}" selected>{{ applicant.first_choice }}</option>
                            <option value="{{ applicant.second_choice }}">{{ applicant.second_choice }}</option>
                        </select>
                    </div>
                    {% elif applicant.second_interview_result == '通过' %}
                    <div class="mb-6">
                        <label for="admission_department" class="block text-sm font-medium text-gray-700 mb-1">录取部门</label>
                        <select name="admission_department" id="admission_department" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-autumn-500 focus:border-autumn-500">
                            <option value="{{ applicant.second_choice }}" selected>{{ applicant.second_choice }}</option>
                        </select>
                    </div>
                    {% endif %}
                    
                    <div class="mb-6">
                        <label for="admission_feedback" class="block text-sm font-medium text-gray-700 mb-1">录取反馈（可选）</label>
                        <textarea name="admission_feedback" id="admission_feedback" rows="3"
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-autumn-500 focus:border-autumn-500"
                                  placeholder="请输入录取反馈意见..."></textarea>
                    </div>
                </div>
                
                <div class="flex justify-end">
                    <button type="submit" class="px-6 py-2 bg-autumn-600 text-white font-semibold rounded-lg shadow hover:bg-autumn-700 transition-colors transform hover:scale-105 active:scale-95">
                        <i data-lucide="save" class="w-4 h-4 mr-1"></i>保存结果
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 初始化图标
        window.lucide.createIcons();
        
        // 阶段选择逻辑
        const stageSelect = document.getElementById('stage-select');
        const sections = document.querySelectorAll('.stage-section');
        
        function showSection(stage) {
            sections.forEach(section => {
                section.classList.add('hidden');
            });
            
            const activeSection = document.getElementById(`${stage}-section`);
            if (activeSection) {
                activeSection.classList.remove('hidden');
            }
        }
        
        // 初始显示选中的阶段
        showSection(stageSelect.value);
        
        // 监听阶段选择变化
        stageSelect.addEventListener('change', function() {
            showSection(this.value);
        });
    });
</script>
{% endblock %}
