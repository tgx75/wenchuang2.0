<!DOCTYPE html>
{% extends 'admin/admin_base.html' %}

{% block title %}拾光文创 - 部门管理{% endblock %}

{% block page_title %}部门管理{% endblock %}

{% block content %}
<div class="card mb-6">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
        <h3 class="font-semibold text-lg mb-4 md:mb-0">参与面试的部门设置</h3>
        <button id="add-department-btn" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors flex items-center">
            <i class="fa fa-plus mr-2"></i> 添加部门
        </button>
    </div>

    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead>
                <tr>
                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-secondary-500 uppercase tracking-wider w-12">ID</th>
                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-secondary-500 uppercase tracking-wider">部门名称</th>
                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-secondary-500 uppercase tracking-wider">负责人</th>
                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-secondary-500 uppercase tracking-wider">报名人数</th>
                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-secondary-500 uppercase tracking-wider">参与面试</th>
                    <th class="px-6 py-3 bg-gray-50 text-right text-xs font-medium text-secondary-500 uppercase tracking-wider">操作</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for department in departments %}
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-secondary-500">{{ department.id }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="h-8 w-8 bg-primary-100 rounded-full flex items-center justify-center mr-3">
                                <i class="fa fa-sitemap text-primary-600"></i>
                            </div>
                            <div>
                                <div class="text-sm font-medium text-secondary-900">{{ department.name }}</div>
                                <div class="text-xs text-secondary-500">{{ department.description|truncatechars:30 }}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-secondary-500">
                        {{ department.leader_name }}
                        <div class="text-xs text-primary-600">{{ department.leader_email }}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-secondary-500">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                            {{ department.application_count }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only peer department-toggle"
                                   data-id="{{ department.id }}"
                                   {% if department.active_for_interview %}checked{% endif %}>
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-500"></div>
                        </label>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-primary-600 hover:text-primary-900 mr-3 edit-department" data-id="{{ department.id }}">
                            <i class="fa fa-pencil"></i> 编辑
                        </button>
                        <button class="text-red-600 hover:text-red-900 delete-department" data-id="{{ department.id }}">
                            <i class="fa fa-trash"></i> 删除
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="px-6 py-10 text-center text-gray-500">
                        <div class="flex flex-col items-center">
                            <i class="fa fa-sitemap text-4xl mb-3 text-gray-300"></i>
                            <p>暂无部门数据，请添加部门</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- 部门表单模态框 -->
<div id="department-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-md transform transition-all">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold" id="modal-title">添加部门</h3>
                <button id="close-modal" class="text-gray-400 hover:text-gray-500">
                    <i class="fa fa-times"></i>
                </button>
            </div>

            <form id="department-form">
                <input type="hidden" id="department-id">

                <div class="mb-4">
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">部门名称 <span class="text-red-500">*</span></label>
                    <input type="text" id="name" name="name" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                </div>

                <div class="mb-4">
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-1">部门描述</label>
                    <textarea id="description" name="description" rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500"></textarea>
                </div>

                <div class="mb-4">
                    <label for="leader_name" class="block text-sm font-medium text-gray-700 mb-1">负责人姓名 <span class="text-red-500">*</span></label>
                    <input type="text" id="leader_name" name="leader_name" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                </div>

                <div class="mb-4">
                    <label for="leader_email" class="block text-sm font-medium text-gray-700 mb-1">负责人邮箱 <span class="text-red-500">*</span></label>
                    <input type="email" id="leader_email" name="leader_email" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                </div>

                <div class="mb-6">
                    <label class="flex items-center">
                        <input type="checkbox" id="active_for_interview" name="active_for_interview"
                               class="form-checkbox h-5 w-5 text-primary-600">
                        <span class="ml-2 text-sm text-gray-700">参与本次面试招新</span>
                    </label>
                </div>

                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-modal" class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                        取消
                    </button>
                    <button type="submit" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700">
                        保存
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 确认删除模态框 -->
<div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
        <div class="text-center mb-6">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-100 mb-4">
                <i class="fa fa-exclamation-triangle text-2xl text-red-600"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-900">确认删除</h3>
            <p class="text-gray-500 mt-2">您确定要删除这个部门吗？此操作不可撤销，相关的报名数据也会被删除。</p>
        </div>

        <div class="flex justify-center space-x-3">
            <button id="cancel-delete" class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                取消
            </button>
            <button id="confirm-delete" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700">
                确认删除
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function adminPageLoaded() {
        const departmentModal = document.getElementById('department-modal');
        const deleteModal = document.getElementById('delete-modal');
        const departmentForm = document.getElementById('department-form');
        let currentDepartmentId = null;

        // 打开添加部门模态框
        document.getElementById('add-department-btn').addEventListener('click', function() {
            document.getElementById('modal-title').textContent = '添加部门';
            departmentForm.reset();
            document.getElementById('department-id').value = '';
            departmentModal.classList.remove('hidden');
        });

        // 关闭模态框
        document.getElementById('close-modal').addEventListener('click', closeDepartmentModal);
        document.getElementById('cancel-modal').addEventListener('click', closeDepartmentModal);

        function closeDepartmentModal() {
            departmentModal.classList.add('hidden');
        }

        // 关闭删除模态框
        document.getElementById('cancel-delete').addEventListener('click', function() {
            deleteModal.classList.add('hidden');
        });

        // 编辑部门
        document.querySelectorAll('.edit-department').forEach(button => {
            button.addEventListener('click', function() {
                const departmentId = this.getAttribute('data-id');
                currentDepartmentId = departmentId;

                // 这里应该从服务器获取部门数据
                // 演示用：模拟数据填充
                document.getElementById('modal-title').textContent = '编辑部门';
                document.getElementById('department-id').value = departmentId;

                // 实际应用中应该通过AJAX获取数据
                const row = this.closest('tr');
                document.getElementById('name').value = row.querySelector('td:nth-child(2) .text-secondary-900').textContent;
                document.getElementById('leader_name').value = row.querySelector('td:nth-child(3)').textContent.split('\n')[0].trim();

                departmentModal.classList.remove('hidden');
            });
        });

        // 删除部门
        document.querySelectorAll('.delete-department').forEach(button => {
            button.addEventListener('click', function() {
                currentDepartmentId = this.getAttribute('data-id');
                deleteModal.classList.remove('hidden');
            });
        });

        // 确认删除
        document.getElementById('confirm-delete').addEventListener('click', function() {
            if (currentDepartmentId) {
                // 这里应该发送AJAX请求删除部门
                console.log('删除部门:', currentDepartmentId);

                // 演示用：直接从DOM中移除
                document.querySelector(`.delete-department[data-id="${currentDepartmentId}"]`).closest('tr').remove();

                deleteModal.classList.add('hidden');
                showNotification('部门已成功删除', 'success');
            }
        });

        // 提交部门表单
        departmentForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const departmentId = document.getElementById('department-id').value;
            const isEdit = !!departmentId;

            // 这里应该发送AJAX请求保存部门数据
            console.log('保存部门:', {
                id: departmentId,
                name: document.getElementById('name').value,
                description: document.getElementById('description').value,
                leader_name: document.getElementById('leader_name').value,
                leader_email: document.getElementById('leader_email').value,
                active_for_interview: document.getElementById('active_for_interview').checked
            });

            closeDepartmentModal();
            showNotification(isEdit ? '部门已成功更新' : '部门已成功添加', 'success');

            // 实际应用中应该刷新部门列表或添加新行
        });

        // 切换部门是否参与面试
        document.querySelectorAll('.department-toggle').forEach(toggle => {
            toggle.addEventListener('change', function() {
                const departmentId = this.getAttribute('data-id');
                const isActive = this.checked;

                // 这里应该发送AJAX请求更新部门状态
                console.log('更新部门面试状态:', departmentId, isActive);

                showNotification(`部门已${isActive ? '开启' : '关闭'}面试招新`, 'success');
            });
        });

        // 显示通知
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg ${
                type === 'success' ? 'bg-green-100 text-green-800' :
                type === 'error' ? 'bg-red-100 text-red-800' :
                'bg-blue-100 text-blue-800'
            } flex items-center z-50 animate-fade-in`;

            notification.innerHTML = `
                <i class="fa ${
                    type === 'success' ? 'fa-check-circle' :
                    type === 'error' ? 'fa-exclamation-circle' :
                    'fa-info-circle'
                } mr-3 text-xl"></i>
                <span>${message}</span>
                <button onclick="this.closest('div').remove()" class="ml-4 text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times"></i>
                </button>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
    }
</script>
{% endblock %}
